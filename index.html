<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Izu Coastal Radar</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #005f56; 
            --accent: #d35400; 
            --bg: #f0f2f5; 
            --card-bg: #ffffff;
            --text-main: #1a1a1a;
            --text-light: #666;
            --border: #d1d5db;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding-bottom: 60px; }
        
        /* HEADER & HERO */
        header { background: #fff; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .vintage-hero { 
            display: flex; gap: 15px; padding: 20px; overflow-x: auto; 
            background: #FDFBF7; justify-content: center; margin-bottom: 20px;
        }
        .poster-frame { 
            height: 180px; flex-shrink: 0; border: 4px solid #fff; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.2s; 
        }
        .poster-frame:hover { transform: scale(1.05); }
        .poster-frame img { height: 100%; width: auto; display: block; }
        
        .header-content { text-align: center; }
        h1 { margin: 0; font-size: 2rem; font-weight: 800; color: var(--primary); letter-spacing: -0.03em; }
        .subtitle { color: var(--text-light); margin-top: 5px; font-weight: 500; font-size: 1rem; }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }

        /* FIXED STATS DASHBOARD */
        .stats-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: -20px auto 30px auto; /* Pull up closer to header */
            max-width: 900px;
        }
        .stat-card { 
            background: white; 
            padding: 20px 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
            text-align: center; 
            border: 1px solid rgba(0,0,0,0.05);
            flex: 1;
            min-width: 200px;
        }
        .stat-val { font-size: 1.8rem; font-weight: 700; color: var(--primary); line-height: 1.2; }
        .stat-lbl { font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px; margin-top: 8px; font-weight: 600; }
        .stat-sub { font-size: 0.85rem; color: var(--accent); font-weight: 500; margin-top: 4px; }

        /* CONTROLS */
        .controls-wrapper { 
            background: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 30px; 
        }
        .toggles-row { 
            display: flex; justify-content: center; gap: 30px; margin-bottom: 20px; 
            padding-bottom: 20px; border-bottom: 1px solid #eee; 
        }
        .toggle-group { display: flex; align-items: center; gap: 10px; }
        .toggle-label { font-size: 0.75em; font-weight: 800; color: #aaa; letter-spacing: 0.5px; }
        
        .toggle-btn { 
            padding: 6px 16px; border: 1px solid #e5e7eb; background: white; 
            color: var(--text-light); border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem;
            transition: all 0.2s;
        }
        .toggle-btn:hover { background: #f9fafb; border-color: #d1d5db; }
        .toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .filters-row { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; }
        select { 
            padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 6px; 
            font-size: 0.9rem; background: #fff; color: var(--text-main); cursor: pointer;
        }
        .results-count { margin-left: 15px; font-weight: 600; color: var(--text-light); align-self: center; }

        /* GRID */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }
        
        .card { 
            background: white; border-radius: 12px; overflow: hidden; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.3s ease; 
            display: flex; flex-direction: column; border: 1px solid transparent;
        }
        .card:hover { box-shadow: 0 10px 25px rgba(0,0,0,0.1); transform: translateY(-4px); border-color: #e5e7eb; }
        
        .card-img-wrap { height: 220px; background: #f3f4f6; position: relative; overflow: hidden; }
        .card-img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s; }
        .card:hover .card-img { transform: scale(1.05); }
        
        .card-tag-overlay {
            position: absolute; bottom: 10px; left: 10px; display: flex; gap: 5px;
        }
        .tag { 
            background: rgba(0, 95, 86, 0.9); color: white; padding: 4px 10px; 
            border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; 
            backdrop-filter: blur(4px);
        }

        .card-body { padding: 20px; display: flex; flex-direction: column; flex-grow: 1; }
        
        .price-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
        .card-price { font-size: 1.6rem; font-weight: 800; color: var(--text-main); }
        .card-sqm { font-weight: 600; color: var(--text-light); font-size: 0.95rem; }
        
        .card-title { 
            font-size: 1.05rem; font-weight: 600; color: var(--primary); 
            text-decoration: none; line-height: 1.4; margin-bottom: 15px; display: block;
        }
        .card-title:hover { text-decoration: underline; }
        
        .card-footer { 
            margin-top: auto; padding-top: 15px; border-top: 1px solid #f3f4f6; 
            font-size: 0.8rem; color: #888; display: flex; justify-content: space-between;
        }
        
        .no-listings { grid-column: 1 / -1; text-align: center; padding: 60px; color: var(--text-light); font-size: 1.1em; background: white; border-radius: 8px; }
        
        /* Mobile adjustment */
        @media (max-width: 600px) {
            .stats-container { flex-direction: column; }
            .toggles-row { flex-direction: column; gap: 10px; align-items: center; }
            .toggle-group { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

<header>
    <div class="vintage-hero">
        <div class="poster-frame"><img src="assets/images/17E88B82-01F3-4A60-9571-935741E304B9.jpeg"></div>
        <div class="poster-frame"><img src="assets/images/42DD5202-2825-48D4-BC01-1AF67FD8BFBE.jpeg"></div>
        <div class="poster-frame"><img src="assets/images/57D6E8AA-D359-417A-AB92-037676775478.jpeg"></div>
        <div class="poster-frame"><img src="assets/images/715105E4-F9EB-405D-A0E4-3D0C8C82EDE6.jpeg"></div>
        <div class="poster-frame"><img src="assets/images/F62A2A51-B69F-4496-9061-1020FDC053B9.jpeg"></div>
    </div>
    
    <div class="header-content">
        <h1>Izu Coastal Radar</h1>
        <div class="subtitle">Market Intelligence for Shimoda & Minami-Izu</div>
    </div>
</header>

<div class="container">
    
    <div class="stats-container" id="stats-panel" style="display:none">
        <div class="stat-card">
            <div class="stat-val" id="stat-price">-</div>
            <div class="stat-lbl" id="lbl-avg-price">Avg Price</div>
        </div>
        <div class="stat-card">
            <div class="stat-val" id="stat-size">-</div>
            <div class="stat-lbl" id="lbl-avg-size">Avg Building</div>
        </div>
        <div class="stat-card">
            <div class="stat-val" id="stat-unit">-</div>
            <div class="stat-sub" id="stat-unit-sub">-</div>
            <div class="stat-lbl" id="lbl-unit-price">Unit Price</div>
        </div>
    </div>

    <div class="controls-wrapper">
        <div class="toggles-row">
            <div class="toggle-group">
                <span class="toggle-label">LANG</span>
                <button class="toggle-btn active" id="lang-en" onclick="setLanguage('EN')">EN</button>
                <button class="toggle-btn" id="lang-jp" onclick="setLanguage('JP')">JP</button>
            </div>
            <div class="toggle-group">
                <span class="toggle-label">CURR</span>
                <button class="toggle-btn active" id="curr-jpy" onclick="setCurrency('JPY')">JPY</button>
                <button class="toggle-btn" id="curr-usd" onclick="setCurrency('USD')">USD</button>
            </div>
        </div>

        <div class="filters-row">
            <select id="location-select" onchange="applyFilters()"><option value="all">All Locations</option></select>
            <select id="type-select" onchange="applyFilters()">
                <option value="all">All Types</option>
                <option value="house">House</option>
                <option value="mansion">Mansion</option>
                <option value="land">Land</option>
            </select>
            <select id="seaview-select" onchange="applyFilters()">
                <option value="all">Any View</option>
                <option value="4">Strong View</option>
                <option value="5">Ocean Front</option>
            </select>
            <select id="sort-select" onchange="applyFilters()">
                <option value="price-desc">Price: High-Low</option>
                <option value="price-asc">Price: Low-High</option>
                <option value="size-desc">Size: Large-Small</option>
                <option value="age-desc">Age: Newest</option>
            </select>
            <div class="results-count" id="count-display"></div>
        </div>
    </div>

    <div class="grid" id="listings-container">Loading...</div>
</div>

<script>
    let DATA = { listings: [], rate: 155.0 };
    let STATE = { currency: 'JPY', language: 'EN' };
    
    // NEW PROXY: wsrv.nl is extremely reliable. 
    // We add params to force it to treat it as an image.
    const PROXY_BASE = "https://wsrv.nl/?url=";
    
    const LOC_MAP = { "下田市": "Shimoda City", "伊東市": "Ito City", "東伊豆町": "Higashi-Izu Town", "河津町": "Kawazu Town", "南伊豆町": "Minami-Izu Town" };

    const UI_TEXT = {
        'EN': { avgPrice: "Avg Price", avgBuild: "Avg Building", unitPrice: "Unit Price", perSqm: "per sqm", perSqft: "per sqft", built: "Built", updated: "Updated", locAll: "All Locations" },
        'JP': { avgPrice: "平均価格", avgBuild: "平均建物面積", unitPrice: "単価", perSqm: "平米単価", perSqft: "sqft単価", built: "築年", updated: "更新日", locAll: "全地域" }
    };

    async function init() {
        try {
            const res = await fetch('listings.json');
            if (!res.ok) throw new Error("JSON not found");
            const json = await res.json();
            DATA.listings = json.listings;
            DATA.rate = json.fxRate || 155.0;
            populateLocations();
            applyFilters();
        } catch (e) {
            console.error(e);
            document.getElementById('listings-container').innerHTML = "<p class='no-listings'>Failed to load listings.json. Please check your deployment.</p>";
        }
    }

    function setCurrency(c) { STATE.currency = c; document.querySelectorAll('#curr-jpy, #curr-usd').forEach(b => b.classList.remove('active')); document.getElementById(c === 'JPY' ? 'curr-jpy' : 'curr-usd').classList.add('active'); applyFilters(); }
    function setLanguage(l) { STATE.language = l; document.querySelectorAll('#lang-en, #lang-jp').forEach(b => b.classList.remove('active')); document.getElementById(l === 'EN' ? 'lang-en' : 'lang-jp').classList.add('active'); populateLocations(); applyFilters(); }

    function populateLocations() {
        const sel = document.getElementById('location-select');
        const currentVal = sel.value;
        const cities = [...new Set(DATA.listings.map(l => l.city))].sort();
        const t = UI_TEXT[STATE.language];
        sel.innerHTML = `<option value="all">${t.locAll}</option>`;
        cities.forEach(city => {
            const label = STATE.language === 'EN' ? (LOC_MAP[city] || city) : city;
            sel.innerHTML += `<option value="${city}">${label}</option>`;
        });
        sel.value = currentVal;
    }

    function formatPrice(jpy) {
        if (!jpy) return "N/A";
        return STATE.currency === 'JPY' ? "¥" + (jpy / 1000000).toFixed(1) + "M" : "$" + Math.round(jpy / DATA.rate).toLocaleString();
    }

    function renderStats(items) {
        if (items.length === 0) { document.getElementById('stats-panel').style.display = 'none'; return; }
        document.getElementById('stats-panel').style.display = 'flex';
        const t = UI_TEXT[STATE.language];
        
        const totalP = items.reduce((a, b) => a + (b.priceJpy || 0), 0);
        const totalS = items.reduce((a, b) => a + (b.buildingSqm || 0), 0);
        const countP = items.filter(i => i.priceJpy).length;
        const countS = items.filter(i => i.buildingSqm).length;
        
        const avgP = countP ? totalP / countP : 0;
        const avgS = countS ? totalS / countS : 0;
        const pricePerSqm = (avgS > 0) ? avgP / avgS : 0;
        
        document.getElementById('lbl-avg-price').innerText = t.avgPrice;
        document.getElementById('lbl-avg-size').innerText = t.avgBuild;
        document.getElementById('lbl-unit-price').innerText = t.unitPrice;

        document.getElementById('stat-price').innerText = formatPrice(avgP);
        document.getElementById('stat-size').innerText = Math.round(avgS) + " m²";
        
        if (STATE.currency === 'JPY') {
            document.getElementById('stat-unit').innerText = "¥" + Math.round(pricePerSqm / 10000) + "万";
            document.getElementById('stat-unit-sub').innerText = t.perSqm;
        } else {
            const pricePerSqftUSD = (pricePerSqm / 10.764) / DATA.rate;
            document.getElementById('stat-unit').innerText = "$" + Math.round(pricePerSqftUSD);
            document.getElementById('stat-unit-sub').textContent = t.perSqft;
        }
    }

    function applyFilters() {
        const sortMode = document.getElementById('sort-select').value;
        const typeMode = document.getElementById('type-select').value;
        const locMode = document.getElementById('location-select').value;
        const viewMode = document.getElementById('seaview-select').value;
        let items = [...DATA.listings];

        if (locMode !== 'all') items = items.filter(l => l.city === locMode);
        if (typeMode !== 'all') items = items.filter(l => l.propertyType === typeMode);
        if (viewMode === '4') items = items.filter(l => l.seaViewScore >= 4);
        if (viewMode === '5') items = items.filter(l => l.seaViewScore === 5);

        items.sort((a, b) => {
            if (sortMode === 'price-desc') return (b.priceJpy||0) - (a.priceJpy||0);
            if (sortMode === 'price-asc') return (a.priceJpy||0) - (b.priceJpy||0);
            if (sortMode === 'size-desc') return (b.buildingSqm||0) - (a.buildingSqm||0);
            if (sortMode === 'age-desc') return (a.age||999) - (b.age||999);
        });
        renderListings(items);
        renderStats(items);
    }

    function renderListings(items) {
        const container = document.getElementById('listings-container');
        container.innerHTML = "";
        document.getElementById('count-display').innerText = `${items.length} Listings`;
        const t = UI_TEXT[STATE.language];

        if (items.length === 0) {
            container.innerHTML = `<p class="no-listings">No listings match your filters.</p>`;
            return;
        }

        items.forEach(item => {
            // IMAGE FIX: Use wsrv.nl proxy
            const imgUrl = item.imageUrl 
                ? `${PROXY}${encodeURIComponent(item.imageUrl)}&w=400&h=300&fit=cover` 
                : "https://via.placeholder.com/400x300?text=No+Photo";
                
            const title = STATE.language === 'EN' ? (item.titleEn || item.title) : item.title;
            
            // Build Info
            let details = [];
            if (item.yearBuilt) details.push(`<span>${t.built}: ${item.yearBuilt}</span>`);
            if (item.lastUpdated) details.push(`<span>${t.upd}: ${item.lastUpdated}</span>`);

            const card = `
                <div class="card">
                    <div class="card-img-wrap">
                        <a href="${item.sourceUrl}" target="_blank">
                            <img src="${imgUrl}" class="card-img" loading="lazy" onerror="this.src='https://via.placeholder.com/400x300?text=Error';">
                        </a>
                        <div class="card-tag-overlay">
                            ${item.highlightTags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="price-row">
                            <div class="card-price">${formatPrice(item.priceJpy)}</div>
                            <div class="card-sqm">${item.buildingSqm || '-'} m²</div>
                        </div>
                        <a href="${item.sourceUrl}" target="_blank" class="card-title">${title}</a>
                        <div class="card-footer">${details.join(' &bull; ')}</div>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', card);
        });
    }

    init();
</script>
</body>
</html>

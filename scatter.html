<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Property Scatter — Izu Coastal Radar</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #050505;
      --panel: #151517;
      --border: #2a2a2c;
      --text: #e5e5e7;
      --muted: #86868b;
      --accent: #2997ff;
      --dot: rgba(41,151,255,0.7);
      --grid: rgba(255,255,255,0.06);
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #000;
      border-bottom: 1px solid var(--border);
      padding: 24px 20px;
      text-align: center;
    }
    header h1 { margin: 0; font-size: 1.7rem; font-weight: 800; letter-spacing: -0.5px; }
    header .sub { color: var(--muted); margin-top: 4px; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }
    .nav { margin-top: 10px; }
    .nav a { color: var(--muted); text-decoration: none; font-size: 0.85rem; font-weight: 600; }
    .nav a:hover { color: var(--text); }

    .container { max-width: 1100px; margin: 0 auto; padding: 30px 20px 60px; flex: 1; width: 100%; }

    /* Price filter */
    .filter-bar {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }
    .filter-bar label { font-size: 0.82rem; color: var(--muted); font-weight: 600; white-space: nowrap; }
    .price-slider { display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 200px; }
    .slider-values {
      display: flex; align-items: center; justify-content: center;
      gap: 6px; font-size: 0.8rem; font-weight: 600; color: #ccc; white-space: nowrap;
    }
    .slider-values .price-sep { color: #555; }
    .slider-container { position: relative; height: 24px; }
    .slider-track-bg {
      position: absolute; top: 50%; transform: translateY(-50%);
      width: 100%; height: 4px; background: #333; border-radius: 2px; pointer-events: none;
    }
    .slider-track {
      position: absolute; top: 50%; transform: translateY(-50%);
      height: 4px; background: var(--accent); border-radius: 2px; pointer-events: none;
    }
    /*
     * Mac/Safari dual-range fix: set pointer-events:none on the input element
     * so the tracks don't block each other, then re-enable only on thumbs.
     * This lets both thumbs be independently draggable regardless of z-index.
     */
    .slider-container input[type="range"] {
      position: absolute; width: 100%; top: 50%; transform: translateY(-50%);
      -webkit-appearance: none; appearance: none;
      background: transparent;
      pointer-events: none;   /* track is non-interactive */
      margin: 0; z-index: 3;
    }
    .slider-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--accent); cursor: pointer; border: 2px solid #000;
      pointer-events: all;    /* thumb IS interactive */
    }
    .slider-container input[type="range"]::-moz-range-thumb {
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--accent); cursor: pointer; border: 2px solid #000;
      pointer-events: all;
    }
    #filter-count { font-size: 0.82rem; color: var(--muted); white-space: nowrap; }

    /* Legend */
    .legend { display: flex; gap: 20px; flex-wrap: wrap; align-items: center; margin-bottom: 18px; }
    .legend-item { display: flex; align-items: center; gap: 7px; font-size: 0.82rem; color: var(--muted); }
    .dot-swatch { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .dot-swatch.regular { background: var(--dot); }
    .dot-swatch.nodata  { background: rgba(150,150,160,0.5); border: 1px solid #444; }

    /* Chart wrapper */
    .chart-wrap {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px 20px 20px;
      position: relative;
    }
    svg#scatter { width: 100%; display: block; }

    /* Tooltip — pointer-events:auto lets the user move onto it and click the link */
    #tooltip {
      position: fixed;
      background: #1c1c1e;
      border: 1px solid #3a3a3c;
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 0.82rem;
      pointer-events: auto;   /* hoverable so user can click the link */
      z-index: 999;
      width: 230px;
      opacity: 0;
      transition: opacity 0.12s;
      line-height: 1.6;
    }
    #tooltip.visible { opacity: 1; }
    #tooltip .tt-price { font-size: 1rem; font-weight: 700; color: #fff; margin-bottom: 2px; }
    #tooltip .tt-sub   { color: var(--muted); }
    #tooltip .tt-link  {
      color: var(--accent); font-weight: 600; margin-top: 8px; display: block;
      text-decoration: none;
    }
    #tooltip .tt-link:hover { text-decoration: underline; }

    /* Summary stats */
    .stats-row { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 20px; }
    .stat-card {
      background: var(--panel); border: 1px solid var(--border);
      border-radius: 10px; padding: 12px 18px; flex: 1; min-width: 120px;
    }
    .stat-card .val { font-size: 1.3rem; font-weight: 700; color: #fff; }
    .stat-card .lbl { font-size: 0.75rem; color: var(--muted); margin-top: 2px; text-transform: uppercase; letter-spacing: 0.5px; }

    footer { border-top: 1px solid var(--border); background: #000; padding: 28px 20px; text-align: center; }
    footer a { color: var(--muted); text-decoration: none; font-weight: 600; font-size: 0.9rem; }
    footer a:hover { color: #fff; }
  </style>
</head>
<body>

<header>
  <h1>IZU COASTAL RADAR — SCATTER</h1>
  <div class="sub">Price vs. Property Age · Houses Only · Shimoda &amp; South Izu</div>
  <div class="nav"><a href="index.html">← Back to Radar</a></div>
</header>

<div class="container">

  <div class="filter-bar">
    <label>Price (USD)</label>
    <div class="price-slider">
      <div class="slider-values">
        <span id="price-min-label">$0</span>
        <span class="price-sep">–</span>
        <span id="price-max-label">No limit</span>
      </div>
      <div class="slider-container">
        <div class="slider-track-bg"></div>
        <div class="slider-track" id="slider-track"></div>
        <input type="range" id="price-min-slider" min="0" max="11" value="0">
        <input type="range" id="price-max-slider" min="0" max="11" value="11">
      </div>
    </div>
    <span id="filter-count"></span>
  </div>

  <div class="stats-row" id="stats-row"></div>

  <div class="legend">
    <div class="legend-item">
      <div class="dot-swatch regular"></div>
      <span>House listing</span>
    </div>
    <div class="legend-item">
      <div class="dot-swatch nodata"></div>
      <span>Age unknown (right column)</span>
    </div>
  </div>

  <div class="chart-wrap">
    <svg id="scatter" aria-label="Property scatter plot"></svg>
  </div>

</div>

<div id="tooltip"></div>

<footer>
  <a href="index.html">← Izu Coastal Radar</a>
</footer>

<script>
// ── Config ──────────────────────────────────────────────────────────────────
const CURRENT_YEAR  = new Date().getFullYear();
const NODATA_ZONE_W = 90;
const MARGIN = { top: 40, right: NODATA_ZONE_W + 30, bottom: 60, left: 80 };

// Price steps in USD thousands (null = no limit)
const USD_STEPS_K = [0, 25, 50, 75, 100, 150, 200, 250, 300, 400, 500, null];
const N_STEPS = USD_STEPS_K.length - 1;  // = 11

let FX = 156.06;
let ALL_DATA = [];

// ── Price slider setup ────────────────────────────────────────────────────────
function fmtStep(k) {
  if (k === null) return "No limit";
  if (k === 0)    return "$0";
  if (k >= 1000)  return `$${k / 1000}M`;
  return `$${k}k`;
}

function stepToJpy(k) {
  // k is USD thousands; null = no limit
  return k === null ? null : k * 1000 * FX;
}

function syncSlider(which) {
  const minS = document.getElementById('price-min-slider');
  const maxS = document.getElementById('price-max-slider');
  let lo = parseInt(minS.value);
  let hi = parseInt(maxS.value);
  if (which === 'min' && lo >= hi) { lo = hi - 1; minS.value = lo; }
  if (which === 'max' && hi <= lo) { hi = lo + 1; maxS.value = hi; }
  document.getElementById('price-min-label').textContent = fmtStep(USD_STEPS_K[lo]);
  document.getElementById('price-max-label').textContent = fmtStep(USD_STEPS_K[hi]);
  const pct = i => (i / N_STEPS) * 100;
  const track = document.getElementById('slider-track');
  track.style.left  = pct(lo) + '%';
  track.style.width = (pct(hi) - pct(lo)) + '%';
  redraw();
}

function getFilteredListings() {
  const lo = parseInt(document.getElementById('price-min-slider').value);
  const hi = parseInt(document.getElementById('price-max-slider').value);
  const jpyMin = stepToJpy(USD_STEPS_K[lo]);
  const jpyMax = stepToJpy(USD_STEPS_K[hi]);
  return ALL_DATA.filter(l => {
    const p = l.priceJpy || 0;
    if (jpyMin !== null && p < jpyMin) return false;
    if (jpyMax !== null && p > jpyMax) return false;
    return true;
  });
}

// ── Data loading ─────────────────────────────────────────────────────────────
async function loadData() {
  const [listingsRes, buildRes] = await Promise.all([
    fetch(`listings.json?t=${Date.now()}`),
    fetch(`buildInfo.json?t=${Date.now()}`).catch(() => null)
  ]);
  const { listings } = await listingsRes.json();
  if (buildRes && buildRes.ok) {
    const bi = await buildRes.json();
    if (bi.forexRate) FX = bi.forexRate;
  }
  // Exclude land listings — they will never have age data and skew the chart
  return listings.filter(l => l.propertyType !== 'land');
}

// ── Formatting ───────────────────────────────────────────────────────────────
function fmtJpy(v) { return `¥${Math.round(v / 10_000).toLocaleString()}万`; }
function fmtUsd(v) {
  const u = Math.round(v / FX);
  if (u >= 1_000_000) return `$${(u / 1_000_000).toFixed(2)}M`;
  return `$${Math.round(u / 1000).toLocaleString()}k`;
}
function jpy2usd(v) { return v / FX; }
function fmtUsdShort(v) {
  if (v === 0)           return "$0";
  if (v >= 1_000_000)    return `$${(v / 1_000_000).toFixed(1)}M`;
  if (v >= 1_000)        return `$${Math.round(v / 1000)}k`;
  return `$${Math.round(v)}`;
}

const CITY_MAP = { "下田": "Shimoda", "河津": "Kawazu", "東伊豆": "Higashi-Izu", "南伊豆": "Minami-Izu", "賀茂郡": "Minami-Izu" };
function cityEn(c) { return CITY_MAP[c] || c; }

// ── SVG helpers ──────────────────────────────────────────────────────────────
function svgEl(tag, attrs = {}) {
  const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
  for (const [k, v] of Object.entries(attrs)) el.setAttribute(k, v);
  return el;
}
function svgText(content, attrs = {}) {
  const t = svgEl("text", attrs);
  t.textContent = content;
  return t;
}

// ── Tooltip ───────────────────────────────────────────────────────────────────
const tooltip = document.getElementById("tooltip");
let hideTimer = null;

function showTooltip(dotEl, l) {
  clearTimeout(hideTimer);
  const age  = l.yearBuilt ? `${CURRENT_YEAR - l.yearBuilt} yrs old (built ${l.yearBuilt})` : "Age unknown";
  const name = extractName(l);
  tooltip.innerHTML = `
    <div class="tt-price">${fmtUsd(l.priceJpy)}</div>
    <div class="tt-sub">${fmtJpy(l.priceJpy)}</div>
    <div class="tt-sub" style="margin-top:4px">${name} · ${cityEn(l.city)}</div>
    <div class="tt-sub">${age}</div>
    <a class="tt-link" href="${l.sourceUrl}" target="_blank" rel="noopener">View listing →</a>
  `;
  // Anchor tooltip to the dot rather than the cursor, so the user can
  // move onto it without it jumping away.
  const rect = dotEl.getBoundingClientRect();
  const tw = 230, th = 140;
  let tx = rect.right + 12;
  let ty = rect.top + rect.height / 2 - th / 2;
  if (tx + tw > window.innerWidth - 8)  tx = rect.left - tw - 12;
  if (ty < 8)                            ty = 8;
  if (ty + th > window.innerHeight - 8) ty = window.innerHeight - th - 8;
  tooltip.style.left = tx + "px";
  tooltip.style.top  = ty + "px";
  tooltip.classList.add("visible");
}

function scheduleHide() {
  hideTimer = setTimeout(() => tooltip.classList.remove("visible"), 220);
}

// Keep tooltip alive while mouse is over it
tooltip.addEventListener("mouseenter", () => clearTimeout(hideTimer));
tooltip.addEventListener("mouseleave", () => tooltip.classList.remove("visible"));

// ── Redraw ────────────────────────────────────────────────────────────────────
function redraw() {
  const listings   = getFilteredListings();
  const withAge    = listings.filter(l => l.yearBuilt);
  const withoutAge = listings.filter(l => !l.yearBuilt);

  document.getElementById('filter-count').textContent = `${listings.length} listings`;
  renderStats(listings, withAge);

  const svg = document.getElementById("scatter");
  while (svg.firstChild) svg.removeChild(svg.firstChild);
  drawChart(listings, withAge, withoutAge);
}

// ── Main ─────────────────────────────────────────────────────────────────────
async function main() {
  ALL_DATA = await loadData();

  // Wire slider events (programmatic, not inline, for reliable Safari behaviour)
  document.getElementById('price-min-slider').addEventListener('input', () => syncSlider('min'));
  document.getElementById('price-max-slider').addEventListener('input', () => syncSlider('max'));

  syncSlider(null);   // initialise labels + track without clamping
}

function renderStats(listings, withAge) {
  const row = document.getElementById("stats-row");
  const prices = listings.map(l => l.priceJpy).filter(Boolean);
  if (!prices.length) { row.innerHTML = ""; return; }

  const sorted = [...prices.map(p => jpy2usd(p))].sort((a, b) => a - b);
  const median = sorted[Math.floor(sorted.length / 2)];
  const ages   = withAge.map(l => CURRENT_YEAR - l.yearBuilt).sort((a, b) => a - b);
  const medianAge = ages.length ? ages[Math.floor(ages.length / 2)] : null;

  const stats = [
    { val: listings.length,                                        lbl: "Houses shown"  },
    { val: fmtUsd(Math.max(...prices)),                            lbl: "Highest price" },
    { val: `$${Math.round(median / 1000)}k`,                      lbl: "Median price"  },
    { val: medianAge !== null ? `${medianAge} yrs` : "—",         lbl: "Median age"    },
    { val: `¥${Math.round(FX)}`,                                   lbl: "USD/JPY rate"  },
  ];
  row.innerHTML = stats.map(s =>
    `<div class="stat-card"><div class="val">${s.val}</div><div class="lbl">${s.lbl}</div></div>`
  ).join("");
}

function drawChart(listings, withAge, withoutAge) {
  const svg = document.getElementById("scatter");
  const containerW = svg.parentElement.clientWidth - 40;
  const W = Math.max(400, containerW);
  const H = Math.max(420, Math.round(W * 0.52));
  svg.setAttribute("viewBox", `0 0 ${W} ${H}`);
  svg.setAttribute("height", H);

  const plotW = W - MARGIN.left - MARGIN.right;
  const plotH = H - MARGIN.top - MARGIN.bottom;

  if (!listings.length) {
    svg.appendChild(svgText("No listings match the current filter", {
      x: W / 2, y: H / 2, "text-anchor": "middle",
      fill: "#666", "font-size": "14", "font-family": "Inter, sans-serif"
    }));
    return;
  }

  // ── Scales ──────────────────────────────────────────────────────────────────
  const ages    = withAge.map(l => CURRENT_YEAR - l.yearBuilt);
  const maxAge  = Math.max(...(ages.length ? ages : [50]), 50);
  const prices  = listings.map(l => jpy2usd(l.priceJpy));
  const maxP    = Math.max(...prices) * 1.08;

  function scaleX(age) { return MARGIN.left + (age / maxAge) * plotW; }
  function scaleY(usd) { return MARGIN.top + plotH - (usd / maxP) * plotH; }
  const noDataX = W - MARGIN.right + 15;

  // ── Grid & axes ─────────────────────────────────────────────────────────────
  const g = svgEl("g");

  for (const tick of niceYTicks(0, maxP, 6)) {
    const y = scaleY(tick);
    g.appendChild(svgEl("line", { x1: MARGIN.left, y1: y, x2: MARGIN.left + plotW, y2: y, stroke: "rgba(255,255,255,0.05)", "stroke-width": 1 }));
    g.appendChild(svgText(fmtUsdShort(tick), { x: MARGIN.left - 8, y: y + 4, "text-anchor": "end", fill: "#666", "font-size": "11", "font-family": "Inter, sans-serif" }));
  }
  for (const tick of niceXTicks(0, maxAge, 6)) {
    const x = scaleX(tick);
    g.appendChild(svgEl("line", { x1: x, y1: MARGIN.top, x2: x, y2: MARGIN.top + plotH, stroke: "rgba(255,255,255,0.05)", "stroke-width": 1 }));
    g.appendChild(svgText(`${tick}y`, { x, y: MARGIN.top + plotH + 18, "text-anchor": "middle", fill: "#666", "font-size": "11", "font-family": "Inter, sans-serif" }));
  }

  g.appendChild(svgEl("line", { x1: MARGIN.left, y1: MARGIN.top, x2: MARGIN.left, y2: MARGIN.top + plotH, stroke: "#444", "stroke-width": 1 }));
  g.appendChild(svgEl("line", { x1: MARGIN.left, y1: MARGIN.top + plotH, x2: MARGIN.left + plotW, y2: MARGIN.top + plotH, stroke: "#444", "stroke-width": 1 }));

  g.appendChild(svgText("Price (USD)", {
    x: MARGIN.left - 55, y: MARGIN.top + plotH / 2,
    transform: `rotate(-90, ${MARGIN.left - 55}, ${MARGIN.top + plotH / 2})`,
    "text-anchor": "middle", fill: "#888", "font-size": "12", "font-family": "Inter, sans-serif"
  }));
  g.appendChild(svgText("Property Age (years)", {
    x: MARGIN.left + plotW / 2, y: H - 8,
    "text-anchor": "middle", fill: "#888", "font-size": "12", "font-family": "Inter, sans-serif"
  }));

  // "Age Unknown" column
  g.appendChild(svgEl("line", { x1: W - MARGIN.right + 5, y1: MARGIN.top, x2: W - MARGIN.right + 5, y2: MARGIN.top + plotH, stroke: "#333", "stroke-dasharray": "4 4", "stroke-width": 1 }));
  g.appendChild(svgText("Age",     { x: noDataX, y: MARGIN.top - 18, "text-anchor": "middle", fill: "#555", "font-size": "10", "font-family": "Inter, sans-serif" }));
  g.appendChild(svgText("Unknown", { x: noDataX, y: MARGIN.top - 6,  "text-anchor": "middle", fill: "#555", "font-size": "10", "font-family": "Inter, sans-serif" }));

  svg.appendChild(g);

  // ── Dots ─────────────────────────────────────────────────────────────────────
  function makeDot(l, cx, cy, grey) {
    const r      = 6;
    const color  = grey ? "rgba(140,140,150,0.45)" : "rgba(41,151,255,0.65)";
    const hcolor = grey ? "rgba(160,160,170,0.8)"  : "#2997ff";
    const stroke = grey ? "rgba(100,100,110,0.6)"  : "rgba(41,151,255,0.9)";

    const dot = svgEl("circle", { cx, cy, r, fill: color, stroke, "stroke-width": 0.8, style: "cursor:pointer; transition: r 0.1s;" });

    dot.addEventListener("mouseenter", () => {
      dot.setAttribute("r", r + 3);
      dot.setAttribute("fill", hcolor);
      showTooltip(dot, l);
    });
    dot.addEventListener("mouseleave", () => {
      dot.setAttribute("r", r);
      dot.setAttribute("fill", color);
      scheduleHide();
    });
    dot.addEventListener("click", () => window.open(l.sourceUrl, "_blank"));
    svg.appendChild(dot);
  }

  for (const l of withoutAge) {
    makeDot(l, noDataX + (Math.random() - 0.5) * 24, scaleY(jpy2usd(l.priceJpy)), true);
  }
  for (const l of withAge) {
    makeDot(l, scaleX(CURRENT_YEAR - l.yearBuilt), scaleY(jpy2usd(l.priceJpy)), false);
  }
}

function extractName(l) {
  const m = l.title?.match(/^([^（「(]+)/);
  return m ? m[1].trim().slice(0, 28) : (l.titleEn || "Property");
}

function niceYTicks(min, max, count) {
  const step = niceStep((max - min) / count);
  const ticks = [];
  for (let t = Math.ceil(min / step) * step; t <= max; t += step) ticks.push(t);
  return ticks;
}
function niceXTicks(min, max, count) {
  const step = niceStep((max - min) / count);
  const ticks = [];
  for (let t = 0; t <= max; t += step) { if (t >= min) ticks.push(t); }
  return ticks;
}
function niceStep(raw) {
  const mag  = Math.pow(10, Math.floor(Math.log10(raw)));
  const norm = raw / mag;
  return (norm < 1.5 ? 1 : norm < 3 ? 2 : norm < 7 ? 5 : 10) * mag;
}

main().catch(e => {
  document.querySelector(".chart-wrap").innerHTML =
    `<p style="color:#f66;padding:20px">Error loading data: ${e.message}</p>`;
});
</script>
</body>
</html>
